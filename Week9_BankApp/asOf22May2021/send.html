<!DOCTYPE html>

<html lang="en">
    
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- <link href="https://fonts.googleapis.com/css2?family=Merienda+One&display=swap" rel="stylesheet"> -->
        <link href="https://fonts.googleapis.com/css2?family=Barlow+Semi+Condensed&display=swap" rel="stylesheet"> 
        <link rel="stylesheet" href="send.css">
        <title>Bank App Transfer</title>   
    </head>
    <body>
        <header class="header" id="header">
            <nav class="navBar"  id="navBar">
                <ul class="navSection" id="navSection">
                    <li id="records">Records</li>
                    <li id="openAcct">Open Account</li>
                    <li id="deposit">Deposit</li>
                    <li id="withdraw">Withdraw</li>
                    <li id="transfer">Transfer</li>
                    <li id="logout">Logout</li>
                </ul>
            </nav>
        </header> 
        <div id="updateBalancePage">
            <div>
                <h1>Omega Bank Management System</h1>
                <h2 id="sectionTitle"> Fund Transfer Section</h2>
            </div>
            <div id="transactionSection">
                <form id="transactionForm" >
                    <!-- <div id="transactionSection" class="transactionSection">
                        <select name="transactionType" id="transactionType" class="transactionType">
                            <option value="chooseType">Choose Type</option>
                            <option value="Deposit">Deposit</option>
                            <option value="Withdraw">Withdraw</option>
                            <option value="Send">Send</option>
                        </select>
                    </div> -->
                    <!-- <div id="depWithSection"> 
                        SHOW DURING WITHDRAW/DEPOSIT
                        <label for="Amount" >Amount</label>
                        <br>
                        <input type="number" 
                        id="transactionAmount" 
                        class="transactionAmount"  
                        minimum = "0" 
                        placeholder="Php" 
                        required 
                        autofocus>
                        <br>
                        <label for="accountName">Account Name</label>
                        <br>
                        <input id="accountName" 
                        class="accountName"   
                        type="text" 
                        placeholder="Account Name" 
                        required autofocus> 
                        <br>
                    </div> -->
                    <div id="sendSection">
                        <label for="Amount" >Amount</label>
                        <br>
                        <input type="number" 
                        id="transactionAmount" 
                        class="transactionAmount"  
                        minimum = "0" 
                        placeholder="Php" 
                        required 
                        autofocus>
                        <br>
                        <label for="senderName">Sender Name</label>
                        <br>
                        <input id="senderName" 
                        class="senderName"   type="text" placeholder="Sender Name" autofocus> 
                        <br>
                        <!-- <label for="senderAccountNumber"> Sender Account Number</label>
                        <br>
                        <input id="senderAccountNumber" 
                        class="senderAccountNumber"   type="number" placeholder="Account Number" autofocus> 
                        <br> -->
                        <label for="receiverName">Receiver Name</label>
                        <br>
                        <input id="receiverName" 
                        class="receiverName"   type="text" placeholder="Receiver Name" autofocus> 
                        <!-- <br>
                        <label for="receiverAccountNumber">Receiver Account Number</label>
                        <br>
                        <input id="receiverAccountNumber" 
                        class="receiverAccountNumber"   type="number" placeholder="Account Number" autofocus> 
                        <br> -->
                    </div>
                    <div id="submitMainBtnContainer" class ="submitMainBtnContainer">
                        <input type="button" value="Submit" id="submitBtn" form="transaction_form" class="btn">
                        <br>
                        <!-- <input type="button" value="Main Page" id="mainPageBtn" form="transaction_form" class="btn"> -->
                    </div>
                        
                </form>

            </div>
            <div id="depWithTableContainer">
                <p id="depWithAccountName"> Account Name:</p>
                <p id="depWithcurrentBalance"> Current Balance:</p>
                <table id="depWithTable">
                    <tr class="topOfTable">
                        <th>Transaction Type</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Balance</th>
                    </tr>
                </table>
            </div>

            <div id="senderTableContainer">
                <p id="senderTableName"> Sender Account Name:</p>
                <p id="senderTableCurrentBalance"> Current Balance:</p>
                <table id="senderTable">
                    <tr class="topOfTable">
                        <th>Transaction Type</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Balance</th>
                    </tr>
                </table>
            </div>
            <div id="receiverTableContainer">
                <p id="receiverTableName"> Receiver Account Name:</p>
                <p id="receiverTableCurrentBalance"> Current Balance:</p>
                <table id="receiverTable">
                    <tr class="topOfTable">
                        <th>Transaction Type</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Balance</th>
                    </tr>
                </table>
            </div> 
            <div id="modal-container1" class="modal-container">
                <div id="startWithNum" class="modal">
                    <h2 id="h2Modal">Error: Name start with a number. Please enter valid name that starts with a letter.</h2>
                    <button id="okBtn1" class="btn">OK</button>
                </div>
            </div>

            <div id="modal-container2" class="modal-container">
                <div id="negativeNum" class="modal">
                    <h2 id="h2Modal">Error: Amount cannot be a negative number.</h2>
                    <button id="okBtn2" class="btn">OK</button>
                </div> 
            </div>

            <div id="modal-container3" class="modal-container">
                <div id="existsNotSender" class="modal">
                    <h2 id="h2Modal">Error: Sender does not exist!</h2>
                    <button id="okBtn3" class="btn">OK</button>
                </div>
            </div>
              
            <div id="modal-container4" class="modal-container">
                <div id="successful" class="modal">
                    <h2 id="h2Modal">Transfer fund success!</h2>
                    <button id="okBtn4" class="btn">OK</button>
                </div>
            </div>

            <div id="modal-container5" class="modal-container">
                <div id="existsNotReceiver" class="modal">
                    <h2 id="h2Modal">Error: Receiver does not exist!</h2>
                    <button id="okBtn5" class="btn">OK</button>
                </div>
            </div>

            <div id="modal-container6" class="modal-container">
                <div id="insufBal" class="modal">
                    <h2 id="h2Modal">Error: Insufficient balance!</h2>
                    <button id="okBtn6" class="btn">OK</button>
                </div>
            </div>

            <div id="modal-container7" class="modal-container">
                <div id="nameInvalid" class="modal">
                    <h2 id="h2Modal">Error: Name input empty! Please enter a name that starts with a letter.</h2>
                    <button id="okBtn7" class="btn">OK</button>
                </div>
            </div>

            
                
        </div>
        
    </body>
    <script src="accounting.js"></script>
    <script src="navBar.js"></script>

    </script>
    <script>
        //GLOBAL VARIABLES
        //1. FOR ACCOUNT AND TRANSACTION LIST OBJECTS
        let bankAccountList;
        let transactionList;

        //2. DOM FORM
        var transTypeHeader         = document.getElementById("transTypeHeader");
        var accountName             = document.getElementById("accountName");
        var transactionForm         = document.querySelector("form")
                                    ? document.querySelector("form")
                                    : " ";
        var transactionAmount       = document.getElementById("transactionAmount");
        //DOM DEP/WITH INPUT FIELDS
        // var depWithSection          = document.getElementById("depWithSection"); 
        // var transactionType         = document.getElementById("transactionType");
        var submitMainBtnContainer  = document.getElementById("submitMainBtnContainer");
        var submitBtn               = document.getElementById("submitBtn");
        // var mainPageBtn             = document.getElementById("mainPageBtn");

        //DOM MODALS
        var startWithNumModal       = document.getElementById("modal-container1");
        var negativeNumModal        = document.getElementById("modal-container2");   
        var existsNotSenderModal    = document.getElementById("modal-container3");
        var successModal            = document.getElementById("modal-container4");
        var existsNotRecModal       = document.getElementById("modal-container5");
        var insufBalModal           = document.getElementById("modal-container6");
        var nameInvalidModal        = document.getElementById("modal-container7");

        //MODAL BUTTONS 
        var okBtn1                  = document.getElementById("okBtn1");
        var okBtn2                  = document.getElementById("okBtn2");
        var okBtn3                  = document.getElementById("okBtn3");
        var okBtn4                  = document.getElementById("okBtn4");
        var okBtn5                  = document.getElementById("okBtn5");
        var okBtn6                  = document.getElementById("okBtn6");
        var okBtn7                  = document.getElementById("okBtn7");

        var sendSection             = document.getElementById("sendSection");
        var senderName              = document.getElementById("senderName");
        var senderAccountNumber     = document.getElementById("senderAccountNumber");
        var receiverName            = document.getElementById("receiverName");
        var receiverAccountNumber   = document.getElementById("receiverAccountNumber");

        //Table for account history
        var senderContainer         = document.getElementById("senderTableContainer");
        var senderAccountName       = document.getElementById("senderAccountName");
        var senderCurrentBalance    = document.getElementById("senderCurrentBalance");
        var senderWithTable         = document.getElementById("senderTable");

        var receiverContainer       = document.getElementById("receiverTableContainer");
        var receiverAccountName     = document.getElementById("receiverAccountName");
        var receiverCurrentBalance  = document.getElementById("receiverCurrentBalance");
        var receiverWithTable       = document.getElementById("receiverTable");
        
        
        //notes on duplicate empty objects in LS upon loading and submission of forms 
        //from S' martney place in function then invoke it para hindi kada load ng page ay gagawa siya ng object: NOT WORKING
        //from Edwin add function to prevent form from loading after form submission: https://www.youtube.com/watch?v=NxVCq4p0Kb0&t=319s
        //https://eloquentjavascript.net/2nd_edition/18_forms.html: WORKING

        //!!!!IMPORTANT DONT FORGET THIS IN EVERY PAGE!!!!
        //get bankAccountList from local storage if bank is not yet in LS, create new object
        function getOrCreateBankAccountList(){
            bankAccountList =  JSON.parse(localStorage.getItem("bankAccountList"))
                ? JSON.parse(localStorage.getItem("bankAccountList"))
                : [];
        }

        getOrCreateBankAccountList();

        function getOrCreateTransactionList(){
            transactionList = JSON.parse(localStorage.getItem("transactionList"))
                            ? JSON.parse(localStorage.getItem("transactionList"))
                            : [];
        }

        getOrCreateTransactionList();

        function convertToInt(){
            var i;

            for(i=0; i < bankAccountList.length; i++){
                bankAccountList[i].accountBalance = parseInt(bankAccountList[i].accountBalance)
            }
        }

        //1. CREATE BANK CONSTRUCTOR
        function Bank(name, accountList, transactionList){
            this.bankName           = name;
            this.bankAccountList    = accountList;
            this.transactionList    = transactionList;
        }

         //2. CREATE BANK INSTANCE 
        let bank = new Bank("Omega Bank", bankAccountList, transactionList);

        console.log(bank);

        //ADD SEND TO BANK ACCOUNT LIST OBJECT
        //perform validations that need to compare with those saved in LS
        bank.send = function send(from_user, to_user, amount){
            //get transaction list from LS
            getOrCreateTransactionList();
            //convert acct balances in bankAccountLIst
            convertToInt();

            let date                  = new Date(); 
            //find user in account list and store in this variable
            //find if the input name already exists in local storage; if there is no existing name in LS return as empty to prevent error
            let sender = bank.bankAccountList.find(account => account.accountName === from_user)
                                      ? bankAccountList.find(account => account.accountName === from_user)
                                      : " ";

            let receiver = bank.bankAccountList.find(account => account.accountName === to_user)
                                      ? bankAccountList.find(account => account.accountName === to_user)
                                      : " ";
            
            //find users index in account list and store in this variable
            let senderIndex = bank.bankAccountList.findIndex(account => account.accountName === from_user);

            let receiverIndex = bank.bankAccountList.findIndex(account => account.accountName === to_user);

            // console.log(sender)
            // console.log(receiver)
            
            if (amount > sender.accountBalance){
                // alert(`Insufficient balance!`);
                insufBalModal.style.display = "block";
            } else if(sender.accountName !== from_user){
                // alert(`${from_user} does not exist!`);
                existsNotSenderModal.style.display = "block";
            } else if(receiver.accountName !== to_user){
                // alert(`${to_user} does not exist.`);
                existsNotRecModal.style.display = "block";
            } else{
                //subtract from sender balance
                sender.accountBalance -= amount;

                // console.log(sender.accountBalance);
                // console.log(typeof sender.accountBalance);
                
                //add to receiver balance
                receiver.accountBalance += amount;

                // console.log(receiver.accountBalance);
                // console.log(typeof receiver.accountBalance);
                
                //show transaction is successful
                successModal.style.backgroundColor = "transparent";
                successModal.style.display ="block";
               
                //add sender and receiver account changes to bank.bankAcctList array
                bank.bankAccountList.splice(senderIndex, 1, sender);

                bank.bankAccountList.splice(receiverIndex, 1, receiver);

                // console.log(sender)
                // console.log(receiver)
                
                //save changes to bank object to the local Storage
                localStorage.setItem("bankAccountList", JSON.stringify(bankAccountList));

                //create transaction record and push to transactionList
                transaction_sender = {
                    accountName     :  `${sender.accountName}`,
                    Date            : `${date}`,
                    Type            : `Fund transfer`,
                    Description     : `Send Php ${amount}.`,
                    Amount          : `${amount}`,
                    CurrentBalance  : `${sender.accountBalance}`
                };
                
                transaction_receiver = {
                    accountName     :  `${receiver.accountName}`,
                    Date            : `${date}`,
                    Type            : `Fund transfer`,
                    Description     : `Receive Php ${amount}.`,
                    Amount          : `${amount}`,
                    CurrentBalance  : `${receiver.accountBalance}`
                };
                
                transactionList.push(transaction_sender);
                transactionList.push(transaction_receiver);
                
                //save changes to bank object to the local Storage
                localStorage.setItem("transactionList", JSON.stringify(transactionList)); 
                }

                clearForm();

                printSenderTable(from_user);
                printReceiverTable(to_user);

                //hide the send section and buttons 
                sendSection.style.display = "none";
                submitBtn.style.display = "none";
            }
        
        //EVENTLISTENER/HANDLER
        //prevent form from submitting and from creating empty object
        //on submit (the event itself, prevent submission and creation of empty accountowner object)
        transactionForm.addEventListener("submit", function(event) {
            event.preventDefault();
        });

        submitBtn.addEventListener("click", doTransaction);
        // mainPageBtn.addEventListener("click", function(){
        //     location.replace("mainPage.html");
        // });
        
        //reload page when error 
        okBtn1.addEventListener("click", reloadPage);
        okBtn2.addEventListener("click", reloadPage);
        okBtn3.addEventListener("click", reloadPage);
        okBtn5.addEventListener("click", reloadPage);
        okBtn6.addEventListener("click", reloadPage);
        okBtn7.addEventListener("click", reloadPage);

        //do not reload page to show account history
        okBtn4.addEventListener("click", hideModals);

        //when trans successful and employee wants to do another trans, page reloads
        // document.addEventListener("click", reloadPage);

        function reloadPage(){
            window.location.reload();
        }
        
        //perform initial validation checks for name and amount without comparing values to those saved in LS
        function doTransaction() {
            if(senderName.value.match(/^\d/) || receiverName.value.match(/^\d/)){
                startWithNumModal.style.display = "block";
            } else if(senderName.value === "" || senderName.value === undefined || senderName.value === null){
                nameInvalidModal.style.display = "block";
            } else if(receiverName.value === "" || receiverName.value === undefined || receiverName.value === null){
                nameInvalidModal.style.display = "block";
            } else if (parseInt(transactionAmount.value) < 0){
                negativeNumModal.style.display = "block";
            } else {
                bank.send(senderName.value, receiverName.value, parseInt(transactionAmount.value));
            }
            clearForm();
        }

        /*function showBalance (from_user, to_user, amount){

            convertToInt();
            
            let sender = bank.bankAccountList.find(account => account.accountName === from_user)
                                      ? bankAccountList.find(account => account.accountName === from_user)
                                      : " ";

            let receiver = bank.bankAccountList.find(account => account.accountName === to_user)
                                      ? bankAccountList.find(account => account.accountName === to_user)
                                      : " ";

            if(sender.accountName !== from_user){
                alert(`${from_user} does not exist!`);
            } else if(receiver.accountName !== to_user){
                alert(`${to_user} does not exist.`);
            } else if(amount > sender.accountBalance){
                alert("Insufficient balance!");
                
                senderTableName.textContent = `Sender Account Name: ${sender.accountName}`
                senderTableCurrentBalance.textContent = `Current Balance: Php ${sender.accountBalance}`
            } else{

                senderTableContainer.style.display = "block";
                
                sender.accountBalance = accounting.formatMoney(sender.accountBalance, {symbol:"Php" , format: "%s %v"});

                senderTableName.textContent = `Sender Account Name: ${sender.accountName}`
                
                senderTableCurrentBalance.textContent = `Current Balance: ${sender.accountBalance}`
                
                // printSenderTable(from_user);

                receiverTableContainer.style.display = "block";
                receiver.accountBalance = accounting.formatMoney(receiver.accountBalance, {symbol:"Php" , format: "%s %v"});

                receiverTableName.textContent = `Receiver Account Name: ${receiver.accountName}`
                receiverTableCurrentBalance.textContent = `Current Balance: ${receiver.accountBalance}`
                
                // printReceiverTable(to_user);
            }
        }*/

        function printSenderTable(user){
            getOrCreateTransactionList();
            
            var previousTransaction = '<table>'+
            '<tr>'+
            '<th>Transaction Type</th>'+
            '<th>Description</th>'+
            '<th>Amount</th>'+
            '<th>Balance</th>'+
            '</tr>';

            for(var i = 0; i < transactionList.length; i++){
                if(transactionList[i].accountName === user){
                    previousTransaction += '<tr>'+
                    '<td>'+transactionList[i].Type+'</td>'+
                    '<td>'+transactionList[i].Description+'</tD>'+
                    '<td>'+ accounting.formatMoney(parseInt(transactionList[i].Amount), {symbol:"Php" , format: "%s %v"})+'</th>'+
                    '<td>'+ accounting.formatMoney(parseInt(transactionList[i].CurrentBalance),{symbol:"Php" , format: "%s %v"})+'</th>'+
                    '</tr>' 

                    senderTableName.textContent = `Sender Account Name: ${transactionList[i].accountName}`

                    currentBalance = accounting.formatMoney(parseInt(transactionList[i].CurrentBalance),{symbol:"Php" , format: "%s %v"})
            
                    senderTableCurrentBalance.textContent = `Current Balance: ${currentBalance}`
                }
            }
            previousTransaction += '</table>';
            console.log(previousTransaction);
            senderTable.innerHTML = previousTransaction;
            senderTableContainer.style.display = "block";

            
        }

        function printReceiverTable(user){
            getOrCreateTransactionList();
            
            var previousTransaction = '<table>'+
            '<tr>'+
            '<th>Transaction Type</th>'+
            '<th>Description</th>'+
            '<th>Amount</th>'+
            '<th>Balance</th>'+
            '</tr>';

            for(var i = 0; i < transactionList.length; i++){
                if(transactionList[i].accountName === user){
                    previousTransaction += '<tr>'+
                    '<td>'+transactionList[i].Type+'</td>'+
                    '<td>'+transactionList[i].Description+'</tD>'+
                    '<td>'+ accounting.formatMoney(parseInt(transactionList[i].Amount), {symbol:"Php" , format: "%s %v"})+'</th>'+
                    '<td>'+ accounting.formatMoney(parseInt(transactionList[i].CurrentBalance),{symbol:"Php" , format: "%s %v"})+'</th>'+
                    '</tr>' 

                    receiverTableName.textContent = `Receiver Account Name: ${transactionList[i].accountName}`

                    currentBalance = accounting.formatMoney(parseInt(transactionList[i].CurrentBalance),{symbol:"Php" , format: "%s %v"})
                    receiverTableCurrentBalance.textContent = `Current Balance: ${currentBalance}`
                }
            }
            previousTransaction += '</table>';
            console.log(previousTransaction);
            receiverTable.innerHTML = previousTransaction;
            receiverTableContainer.style.display = "block";            
        }
        //FOR TEST PURPOSE
        // printAnotherTable("Lestat");

        function clearForm(){
            //erases inputs after submission
            transactionForm.reset();
        }

        function hideModals(){
            successModal.style.display = "none";
        }

        //FOR TEST PURPOSES
        //localStorage.clear();
        //console.log("clear records");

        //4. ADD FUNCTION TO CREATE USER
        bank.create_user = function create_user(user, balance){

        getOrCreateBankAccountList();
        getOrCreateTransactionList();
        let date           = new Date(); 
        
        // let accountName    = document.getElementById("accountName").value; 

        // let initialDeposit = document.getElementById("initialDeposit").value
        //                 ? document.getElementById("initialDeposit").value
        //                 : 0;

        //find if the input name already exists in local storage; if there is no existing name in LS return as empty to prevent error
        let checkName      = bankAccountList.find(account => account.accountName === user)
                        ? bankAccountList.find(account => account.accountName === user)
                        : " ";

        //check if name starts with num
        if(user.match(/^\d/)){
            // alert(`${user} starts with a number! Please enter valid name that starts with a letter.`)
            // startWithNumModal.style.display = "block";
        }else if( balance < 0){
            // alert(`Initial deposit amount cannot be negative! Please enter a number equal to or greater than 0.`)
            // negativeNumModal.style.display = "block";
        } else if(checkName.accountName === user){
            // alert(`Account already exists!`) 
            // existsModal.style.display = "block";
            
        } else{

            //1. create new account instance
            const account = {
                accountNumber       :  Date.now(),
                accountName         :  user,
                accountBalance      :  balance,
            }
            
            //1.a. add the new account to bankAccountList array
            bankAccountList.push(account);

            //1.b confirm send successful via message prompt
            alert(`Account created for ${user} with initial balance of ${balance}.`);
            // successModal.style.display = "block";

            //1.c save changes to bank object to the local Storage
            localStorage.setItem("bankAccountList", JSON.stringify(bankAccountList));

            //2. create transaction List array to push details into during withdraw send deposit
            const transaction = {
                    accountName     :  user,
                    Date            : `${date}`,
                    Type            : `Open`,
                    Description     : `Account open with initial deposit of Php ${balance}.`,
                    Amount          : balance,
                    CurrentBalance  : balance
                }

            transactionList.push(transaction);
            localStorage.setItem("transactionList", JSON.stringify(transactionList));
        }

        clearForm();
        }

        //TEST CASES
        //1. amount <0
        //bank.create("Marius", -1000);
        //2. all errors false
        bank.create_user("Maria", 50000);
        bank.create_user("Jesse", 20000);
        bank.create_user("Juan", 500000);
        bank.create_user("Lestat", 8000000);
        bank.create_user("Free", 1000);

        //3. Name cannot start with a number: https://stackoverflow.com/questions/39736188/check-if-string-starts-with-a-number
        //bank.create("3aria Santos", 1000);
        
</script>
</html>
